generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URI")
}

enum Role {
  user
  admin
}

enum Purpose {
  register
  reset
  verify
}

enum SubscriptionStatus {
  active
  canceled
  incomplete
  incomplete_expired
  past_due
  unpaid
  trialing
}

enum TransactionStatus {
  success
  failed
  pending
  refunded
}

enum Gender {
  male
  female
}

enum BlockType {
  content
  image
  shape
}

model User {
  id               String  @id @default(uuid())
  fullName         String
  email            String  @unique
  password         String
  age              Int
  gender           Gender
  phone            String
  city             String   
  picture          String?
  isVerified       Boolean @default(false)
  role             Role    @default(user)

  stripeCustomerId String? @unique @map("stripe_customer_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  verification       EmailVerification?
  subscription       UserSubscription?
  transactions       PaymentTransaction[]
  documents          Document[]

  @@index([email])
  @@map("users")
}

model EmailVerification {
  id        String  @id @default(uuid())
  userId    String  @unique
  code      String  @db.Char(4)
  purpose   Purpose
  expiredAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code, purpose, createdAt])
  @@map("email_verifications")
}

model UserSubscription {
  id                   String             @id @default(uuid())
  userId               String              @unique
  stripeSubscriptionId String              @map("stripe_subscription_id")
  stripePriceId        String             @map("stripe_price_id")
  stripeProductId      String?            @map("stripe_product_id")
  status               SubscriptionStatus
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeSubscriptionId, status])
  @@map("user_subscriptions")
}

model PaymentTransaction {
  id                    String  @id @default(uuid())
  userId                String
  stripePaymentIntentId String? @map("stripe_payment_intent_id")
  stripeChargeId        String? @map("stripe_charge_id")
  stripeInvoiceId       String? @map("stripe_invoice_id")
  stripeSubscriptionId  String? @map("stripe_subscription_id")

  amount      Int
  currency    String?           @default("usd")
  status      TransactionStatus
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("payment_transactions")
}

model Document {
  id          String  @id @default(uuid())
  userId      String
  title       String
  previewPath String
  styles      Json?   @db.JsonB
  dimensions  Json?    @db.JsonB

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  blocks Block[]

  @@index([userId, title])
  @@map("documents")
}

model DocumentTemplate {
  id          String  @id @default(uuid())
  title       String
  previewPath String
  styles      Json?   @db.JsonB
  dimensions  Json?    @db.JsonB

  createdAt DateTime @default(now()) @map("created_at")

  blocks Block[]

  @@map("document_templates")
}

model Block {
  id         String  @id @default(uuid())
  documentId String?
  templateId String?
  blockType  BlockType 
  metadata   Json    @db.JsonB
  styles     Json    @db.JsonB

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt

  document Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  template DocumentTemplate? @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([documentId, templateId])
  @@map("blocks")
}
